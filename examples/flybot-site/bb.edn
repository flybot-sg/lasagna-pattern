{:tasks
 {:requires [[clojure.edn :as edn]
             [clojure.string :as str]]

  :init (defn current-env [] (into {} (System/getenv)))

  dev
  {:doc "Start nREPL for development. Connect editor, then (start!) for backend.
         For CLJS: (shadow.cljs.devtools.api/watch :app) then (shadow.cljs.devtools.api/repl :app)"
   :task (clojure {:env (current-env)} "-M:dev:cljs -m nrepl.cmdline --middleware \"[shadow.cljs.devtools.server.nrepl/middleware,cider.nrepl/cider-middleware]\"")}

  serve
  {:doc "Build and serve release frontend on port 3000 (requires backend on 8080)"
   :task (do
           (shell "npm install")
           (clojure "-M:cljs -m shadow.cljs.devtools.cli release app")
           ;; Render index-template.html with hashed asset paths
           (let [manifest (edn/read-string (slurp "resources/public/js/manifest.edn"))
                 js-name (->> manifest (filter (fn [m] (= :main (:module-id m)))) first :output-name)
                 version (or (:version (edn/read-string (slurp "resources/version.edn"))) "dev")
                 rendered (-> (slurp "resources/index-template.html")
                              (str/replace "{{main-js}}" (str "/js/" js-name))
                              (str/replace "{{style-css}}" "/css/style.css")
                              (str/replace "{{version}}" version))]
             (spit "resources/public/index.html" rendered))
           (println "\nServing at http://localhost:3000")
           (println "Note: Backend must be running on port 8080 for API calls")
           (shell "npx http-server resources/public -p 3000 -c-1 --proxy http://localhost:8080"))}

  watch
  {:doc "Start shadow-cljs watch (alternative to REPL-based workflow)"
   :task (shell "npx shadow-cljs -A:dev:cljs watch app")}

  test
  {:doc "Run tests (kaocha includes RCT via rct-test.clj)"
   :task (apply clojure "-M:dev:kaocha" *command-line-args*)}

  clean
  {:doc "Clean build artifacts"
   :task (shell "rm -rf target .shadow-cljs .cpcache")}

  deploy
  {:doc "Build and push container image to ECR (called by CI or manually)"
   :depends [clean]
   :task (do
           ;; Build frontend
           (shell "npm install")
           (clojure "-M:cljs -m shadow.cljs.devtools.cli release app")
           ;; Build and push container
           (clojure "-T:jib build"))}}}
